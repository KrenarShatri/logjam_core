<%= content_for(:page_scripts) do %>
var parameters = <%= raw Oj.dump(params) %>;
var parameter_defaults = <%= raw Oj.dump(default_header_parameters) %>;
var self_url = '<%= raw self_url %>';
var home_url = '<%= raw home_url %>';
var history_url = '<%= raw history_url %>';
var selectable_days = <%= raw Oj.dump(@days.map(&:to_s)) %>;
var auto_complete_url = '<%= raw auto_complete_url_for_action_page %>';
$(document).ready(initialize_header);
<% end %>

<div id="header">
  <% action = action_name == "index" ? "" : action_name %>
  <%= form_tag(params.except(:id).merge(:action => action), :method => :get, :id => "filter-form", :autocomplete => "off") do -%>
  <div id="filter">
    <div id="navigation-widget" class="menu">
      <ul>
        <li><a href="#" onclick="go_home();">Logjam</a>
          <ul>
            <% if @dataset.try(:live_stream?) -%>
            <li>
              <%= link_to("Live Stream", clean_params(params.slice(:app,:env,:page).merge(:action => "live_stream")), {:target => "_blank"}) %>
            </li>
            <li class="separator"></li>
            <% end %>
            <li><%= link_to("Apdex Overview", clean_params(params.merge(:action => "apdex_overview"))) %></li>
            <li><%= link_to("Response Code Overview", clean_params(params.merge(:action => "response_code_overview"))) %></li>
            <li><%= link_to("Problem Overview", clean_params(params.merge(:action => "error_overview"))) %></li>
            <li class="separator"></li>
            <li>
              <%= link_to("Enlarged Resource Plot", clean_params(params.merge(:page =>
                          without_module(@page), :action => "enlarged_plot", :interval => 1))) %>
            </li>
            <% if @dataset.try(:has_distribution_plot?) %>
            <li>
              <%= link_to("Resource Distribution Plot", clean_params(params.merge(:page =>
                          without_module(@page), :action => distribution_kind(@dataset.resource)))) %>
            </li>
            <% end %>
            <li class="separator"></li>
            <li><%= link_to("My Callers", clean_params(params.merge(:action =>"callers"))) %></li>
            <li><%= link_to("Call Relationships", clean_params(params.merge(:action =>"call_relationships"))) %></li>
          </ul>
        </li>
      </ul>
    </div>
    <% unless @only_one_app %>
    <p class="filter-widget">
      <%= label :filter, "application" %><br />
      <%= select_tag "app", options_for_select(@apps, @app), :onchange => "view_selected_pages()" %>
    </p>
    <% end %>
    <% unless @only_one_env %>
    <p class="filter-widget">
      <%= label :filter, "environment" %><br />
      <%= select_tag "env", options_for_select(@envs, @env), :onchange => "view_selected_pages()" %>
    </p>
    <% end %>
    <div class="filter-widget" id="time-range-widget">
      <ul>
        <li <%= raw html_attributes_for_time_range("date") %>>Date</li>
        <li <%= raw html_attributes_for_time_range("history") %>>History</li>
      </ul>
      <input id="time-range" type="hidden" name="time_range" value="<%= params[:time_range] %>" />
      <% if params[:time_range] == "date" %>
      <input size="11" type="text" value="<%= @date %>" id="datepicker" onchange="submit_filter_form()" />
      <% else %>
      <div><input size="11" type="text" value="<%= @date %>" id="datepicker" readonly="readonly" disabled="disabled" /></div>
      <% end %>
    </div>
    <p class="filter-widget">
      <%= label :filter, "page selector" %><br />
      <input id="page-field" class="autocomplete" name="page" size="45" type="text" value="<%= @page %>" onchange="view_selected_pages()" />
    </p>
    <ul class="filter-widget" id="grouping-widget">
      <li <%= raw html_attributes_for_grouping("page") %>>Pages</li>
      <li <%= raw html_attributes_for_grouping("request") %>>Requests</li>
    </ul>
    <p class="filter-widget invisible">
      <%= label :filter, "Show" %><br />
      <%= select_tag "grouping", grouping_options, :onchange => "submit_filter_form()" %>
    </p>
    <div class="menu filter-widget">
      <%= label :filter, "resource selector" %><br />
      <ul id="resource-type-widget">
        <li><a href="#" <%= raw html_attributes_for_resource_type(:time) %>>Time</a>
          <ul>
            <% collected_time_resources.reverse.each do |r| %>
            <li><a href="#" onclick="view_resource('<%=r%>')"><%= hrn(r) %></a></li>
            <% end %>
          </ul>
        </li>
        <% unless collected_call_resources.empty? %>
        <li><a href="#" <%= raw html_attributes_for_resource_type(:call) %>>Calls</a>
          <ul>
            <% collected_call_resources.reverse.each do |r| %>
            <li><a href="#" onclick="view_resource('<%=r%>')"><%= hrn(r) %></a></li>
            <% end %>
          </ul>
        </li>
        <% end %>
        <% unless collected_memory_resources.empty? %>
        <li><a href="#" <%= raw html_attributes_for_resource_type(:memory) %>>Allocations</a>
          <ul>
            <% collected_memory_resources.reverse.each do |r| %>
            <li><a href="#" onclick="view_resource('<%=r%>')"><%= hrn(r) %></a></li>
            <% end %>
          </ul>
        </li>
        <% end %>
        <% unless collected_heap_resources.empty? %>
        <li><a href="#" <%= raw html_attributes_for_resource_type(:heap) %>>Heap</a>
          <ul>
            <% collected_heap_resources.reverse.each do |r| %>
            <li><a href="#" onclick="view_resource('<%=r%>')"><%= hrn(r) %></a></li>
            <% end %>
          </ul>
        </li>
        <% end %>
      </ul>
    </div>
    <p class="filter-widget invisible" id="resource-widget">
      <%= label :filter, "with resource" %><br />
      <%= select_tag "resource", resource_options, :onchange => "submit_filter_form())" %>
    </p>
    <%- if params[:grouping] == "page" -%>
    <p class="filter-widget invisible" id="function-widget">
      <%= label :filter, "sorted by" %><br />
      <%= select_tag "grouping_function", grouping_functions, :onchange => "submit_filter_form()" %>
    </p>
    <%- end -%>
    <% if params[:start_minute] %>
      <input id="start-minute" name="start_minute" type="hidden" value="<%= params[:start_minute] %>" />
    <% end %>
    <% if params[:end_minute] %>
      <input id="end-minute" name="end_minute" type="hidden" value="<%= params[:end_minute] %>" />
    <% end %>
    <% if params[:interval] %>
      <input id="interval" name="interval" type="hidden" value="<%= params[:interval] %>" />
    <% end %>
    <p class="filter-widget" id="auto-refresh">
    <%= check_box_tag "auto_refresh", "1", params[:auto_refresh]=="1", :onchange => "submit_filter_form()" %>Autorefresh
    </p>
  </div>
  <% end %>
</div>
<div id="admin">
  <%= link_to(image_tag("database_gear.png"), admin_storage_path, :title => "admin stuff") %>
</div>
