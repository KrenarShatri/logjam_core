<%- content_for :page_scripts do -%>
var descriptions = <%= resource_descriptions %>;

function show_description() {
  var grouping = $('grouping').value;
  var resource = $('resource').value;
  var gfunction = $('grouping_function').value;

  if (grouping == 'request' || resource == 'requests') {
    $('function-widget').hide();
    if (grouping == 'request')
      $('heap-growth-widget').show();
    $('description').innerHTML = descriptions[grouping][resource];
  }
  else {
    $('description').innerHTML = descriptions[grouping][resource][gfunction];
    $('function-widget').show();
    $('heap-growth-widget').hide();
  }
};

Event.observe(window, 'load', function() {show_description()});
<%- end -%>

<div id='left' class='clear-left'>
  <div id='filter'>
    <% form_tag({:action => :index}, :method => :get, :id => 'filter-form') do -%>
      <fieldset>
        <legend>LogJam for Rails</legend>
        <p class='filter-widget'>
          <%= label :filter, 'date' %><br />
          <%= select_tag 'starts_at', options_for_select(Logjam.database_days, @date.to_s(:db)[0..9]) %>
        </p>
        <p class='filter-widget'>
          <%= label :filter, 'plot timeslice' %><br />
          <%= select_tag 'interval', options_for_select(Logjam.durations.map{|i| [pluralize(i, 'minute'), i]}, params[:interval]) %>
        </p>
        <p class='filter-widget-last'>
          <%= label :filter, 'page name' %><br />
          <%= text_field_with_auto_complete :controller_action, :page, {:name => 'page', :value => @page, :size => 45} %>
        </p>

        <p class='clear-left'></p>

        <p class='filter-widget'>
          <%= label :filter, 'Show' %><br />
          <%= select_tag 'grouping', options_for_select(Resource.grouping_options, params['grouping']),
              :onchange => "show_description()" %>
        </p>
        <p class='filter-widget' id='resource-widget'>
          <%= label :filter, 'with' %><br />
          <%= select_tag 'resource', options_for_select(Resource.resource_options, params['resource']),
              :onchange => "show_description()" %>
        </p>
        <p class='filter-widget' id='function-widget'>
          <%= label :filter, 'sorted by' %><br />
          <%= select_tag 'grouping_function', options_for_select(Resource.grouping_functions, params['grouping_function']),
              :onchange => "show_description()" %>
        </p>
        <%- if Resource.heap_resources.include?("heap_growth") -%>
          <p class='filter-widget-last' id='heap-growth-widget'>
            <%= label :filter, 'heap growth only' %><br />
            <%= check_box_tag 'heap_growth_only', "1", params['heap_growth_only']=="1" %>
          </p>
        <%- end -%>

        <p class='filter-float-right'>
          <br />
          <%= submit_tag 'GO', :class => 'submit' %>
        </p>

        <p class='clear-left'></p>

        <p class='filter-widget' id='description'></p>
      </fieldset>
      <% end -%>
  </div>

  <% if @dataset.empty? -%>
    <p class='warning'>Dataset is empty.</p>
  <% else -%>
    <div id='graph-counts' class='clear-left'>
      <p class='stats'>
        <%= @dataset.date.strftime('%d-%b-%Y') %>: showing
        <%= number_with_delimiter @dataset.count_requests %> of <%= number_with_delimiter @dataset.count %> requests
      </p>
      <%= link_to image_tag(@dataset.png_file, :alt => 'enlarge plot', :title => 'enlarge plot'), {:params => clean_params(params.merge(:action => 'enlarged_plot'))} %>
    </div>

    <%- if [:time, :memory].include? @plot_kind -%>
      <table class='stats clear-left' id='graph-stats'>
        <tr>
          <th></th>
          <th>avg</th>
          <th>stddev</th>
        </tr>
      <% @attributes.each do |attr| -%>
        <tr>
          <td><%= h(attr.to_s.sub(/_time$/, '')) %></td>
          <% if attr =~ /_time/ %>
            <td class='number'><%= time_number(@dataset.statistics(@plot_kind)["avg_#{attr}"].to_f) %></td>
            <td class='number'><%= time_number(@dataset.statistics(@plot_kind)["std_#{attr}"].to_f) %></td>
          <% else %>
            <td class='number'><%= memory_number(@dataset.statistics(@plot_kind)["avg_#{attr}"].to_f) %></td>
            <td class='number'><%= memory_number(@dataset.statistics(@plot_kind)["std_#{attr}"].to_f) %></td>
          <% end %>
        </tr>
      <% end -%>
      </table>
      <div id='distribution-plot'>
        <%= render(:partial => 'time_quintiles') if @plot_kind == :time %>
        <%= button_to "distribution plot",
                    {:params => clean_params(params.merge(:action => distribution_kind(@dataset.resource)))} %>
      </div>
    <%- end -%>

  <% end -%>
  <div class='clear-left'></div>
</div>

<% unless @dataset.empty? -%>
<div id='column-right'>
  <div id='pagetimes'>
    <br />
    <h3><%= @dataset.description %></h3>
    <%= render "page_times" %>
  </div>
</div>
<% end -%>
