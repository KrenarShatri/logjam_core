<% resource = @dataset.resource
   resource_type = Logjam::Resource.resource_type(@dataset.resource)
   gf = @dataset.grouping_function.to_sym
   pages = @dataset.do_the_query
   data = pages.map{|p| p.send(gf, resource)}
   legend = pages.map{|p| p.page}
-%>

<script type="text/javascript+protovis">
(function(){
var data = <%= raw data.to_json %>,
    legend = <%= raw legend.to_json %>;

/* Sizing and scales. */
var w = <%= size rescue 180 %>,
    h = <%= size rescue 180 %>,
    r = w / 2,
    s = pv.sum(data),
    a = pv.Scale.linear(0, s).range(0, 2 * Math.PI);

/* The root panel. */
var vis = new pv.Panel()
    .width(w+400)
    .height(h);

function goto_page(page) {
   if (page != "Others...") {
     jQuery('#page-field').val(page);
     jQuery('#filter-form').submit();
   }
}

/* The wedge, with centered label. */
vis.add(pv.Wedge)
    .data(data)
    .bottom(w / 2)
    .left(w / 2)
    .angle(a)
    .innerRadius(0)
    .outerRadius(r)
    .title(function() legend[this.index])
    .cursor(function() legend[this.index] != "Others..." ? "pointer" : "arrow")
    .event("click", function() goto_page(legend[this.index]))
//    .outerRadius(r-10)
//    .def("o", -1)
//    .left(function() 100
//        + Math.cos(this.startAngle() + this.angle() / 2)
//        * ((this.o() == this.index) ? 10 : 0))
//    .bottom(function() 100
//        - Math.sin(this.startAngle() + this.angle() / 2)
//        * ((this.o() == this.index) ? 10 : 0))
//    .event("mouseover", function() this.o(this.index))
//    .event("mouseout", function() this.o(-1))
  .anchor("center").add(pv.Label)
    .visible(function(d) d/s > .05)
    .textAngle(0)
    .text(function(d) (100*d/s).toFixed()+"%");
;

/* Legend. */
vis.add(pv.Dot)
    .data(legend)
    .left(w+30)
    .bottom(function(d) h-30-14*this.index)
    .lineWidth(1)
    .size(16)
    .visible(function() data[this.index]/s>.02)
    .strokeStyle(function() pv.Colors.category20().range()[this.index])
    .fillStyle(function() pv.Colors.category20().range()[this.index])
    .events("all")
    .cursor("pointer")
    .add(pv.Label)
       .event("click", function() goto_page(legend[this.index]))
       .textBaseline("middle")
       .textMargin(7)
       .text(function() legend[this.index]);

vis.render();
})();
</script>
