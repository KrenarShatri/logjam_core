<% resource = @dataset.resource
   resource_type = Logjam::Resource.resource_type(@dataset.resource)
   gf = @dataset.grouping_function.to_sym
   resource_name = gf == :count ? "count" : "#{resource}_#{gf}"
   pages = @dataset.do_the_query
   data = pages.map{|p| p[resource_name]}
   legend = pages.map{|p| p[:page]}
-%>

<script type="text/javascript+protovis">
(function(){
var data = <%= data.to_json %>,
    legend = <%= legend.to_json %>;

/* Sizing and scales. */
var w = <%= size rescue 180 %>,
    h = <%= size rescue 180 %>,
    r = w / 2,
    s = pv.sum(data),
    a = pv.Scale.linear(0, s).range(0, 2 * Math.PI);

/* The root panel. */
var vis = new pv.Panel()
    .width(w)
    .height(h);

function goto_page(page) {
   jQuery('#controller_action_page').val(page);
   jQuery('#filter-form').submit();
}

/* The wedge, with centered label. */
vis.add(pv.Wedge)
    .data(data)
    .bottom(w / 2)
    .left(w / 2)
    .angle(a)
    .innerRadius(0)
    .outerRadius(r)
    .title(function() legend[this.index])
    .cursor("pointer")
    .event("click", function() goto_page(legend[this.index]))
//    .outerRadius(r-10)
//    .def("o", -1)
//    .left(function() 100
//        + Math.cos(this.startAngle() + this.angle() / 2)
//        * ((this.o() == this.index) ? 10 : 0))
//    .bottom(function() 100
//        - Math.sin(this.startAngle() + this.angle() / 2)
//        * ((this.o() == this.index) ? 10 : 0))
//    .event("mouseover", function() this.o(this.index))
//    .event("mouseout", function() this.o(-1))
  .anchor("center").add(pv.Label)
    .visible(function(d) d/s > .05)
    .textAngle(0)
    .text(function(d) (100*d/s).toFixed()+"%");
;

vis.render();
})();
</script>
