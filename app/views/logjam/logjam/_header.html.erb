<%= content_for(:page_scripts) do %>
var parameters = <%= raw Oj.dump(params) %>;
var parameter_defaults = <%= raw Oj.dump(default_header_parameters) %>;
var self_url = '<%= raw self_url %>';
var home_url = '<%= raw home_url %>';
var history_url = '<%= raw history_url %>';
  <% if @days %>
  var selectable_days = <%= raw Oj.dump(@days.map(&:to_s)) %>;
  <% end %>
var auto_complete_url = '<%= raw auto_complete_url_for_action_page %>';
$(document).ready(initialize_header);
<% end %>

<% action = action_name == "index" ? "" : action_name %>


<header id="logjam-header">
  <h1 class="logo"><a href="/<%= params[:year] %>/<%= params[:month] %>/<%= params[:day] %>/dashboard">LOGJAM</a></h1>
  <% unless @only_one_app %>
    <div class="application-chooser">
      <% if params[:action] == 'dashboard' || !params[:app] %>
        :: <input class="application-suggest" type="text" placeholder="Choose Application"> <i class="fa fa-angle-down"></i>
      <% else %>
        :: <input class="application-suggest" type="text" placeholder="<%= params[:app] %>"> <i class="fa fa-angle-down"></i>
      <% end %>
      <ul class="dropdown-menu">
        <% @apps.map do |app| %>
          <li class="dropdown-header" data-app="<%= app %>"><a <% if params[:app] == app %>class="active"<% end %> href="/<%= params[:year] %>/<%= params[:month] %>/<%= params[:day] %>/?app=<%= app %>&_section=backend"><i class="fa fa-angle-right"></i> <%= app %></a></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <% unless @only_one_env %>
    <div class="enviroment-chooser">
      <% @envs.map do |env| %>
        <% if params[:env] == env %>
          <button type="submit" class="btn active" onclick="view_selected_pages()" value="<%= env %>"><%= env %></button>
        <% else %>
          <button type="submit" class="btn" onclick="view_selected_pages()" value="<%= env %>"><%= env %></button>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <div id="auto-refresh">
    <%= check_box_tag "auto_refresh", "1", params[:auto_refresh]=="1", :onchange => "submit_filter_form()" %> <label for="auto_refresh">Autorefresh</label>
  </div>

  <div class="date-chooser">
      <% if params[:time_range] == "date" %>
        <input size="11" type="text" value="<%= @date %>" id="datepicker" onchange="submit_filter_form()" />
      <% else %>
        <input size="11" type="text" value="<%= @date %>" id="datepicker" readonly="readonly" disabled="disabled" />
      <% end %>
  </div>
</header>

<script>

  $(function(){
    $('.enviroment-chooser .btn', '#logjam-header').on('mousedown', function(event){
      $('#env').val( $(this).val() );
    });

    $('.application-suggest').on('focus', function(event) {
      $('.dropdown-menu li', '.application-chooser').removeClass('active');
    });

    $('.application-suggest').on('keyup', function(event) {
      if( $(this).val().length == 0 ) {
        $('.dropdown-menu li', '.application-chooser').removeClass('hide');
        return;
      }

      var app = $(this).val().toLowerCase();
      $('.dropdown-menu li', '.application-chooser').each(function(){
        if( $(this).data('app').toLowerCase().indexOf(app) === -1 ) {
          $(this).addClass('hide');
        }
        else {
          $(this).removeClass('hide');
        }
      });
      if( event.keyCode == 40 ) {
        if( $('.dropdown-menu li.active', '.application-chooser').length > 0 ) {
          var $current = $('.dropdown-menu li.active', '.application-chooser');
          $current.removeClass('active')
                  .next(':not(.hide)').addClass('active');
        }
        else {
          $('.dropdown-menu li:not(.hide)', '.application-chooser').first().addClass('active');
        }
      }

      if( event.keyCode == 38 ) {
        if( $('.dropdown-menu li.active', '.application-chooser').length > 0 ) {
          var $current = $('.dropdown-menu li.active', '.application-chooser');
          $current.removeClass('active')
                  .prev(':not(.hide)').addClass('active');
        }
        else {
          $('.dropdown-menu li:not(.hide)', '.application-chooser').last().addClass('active');
        }
      }

      if( event.keyCode == 13 && $('.dropdown-menu li.active a', '.application-chooser').length > 0 ) {
        location.href = $('.dropdown-menu li.active a', '.application-chooser').attr('href');
      }
    });
  });

</script>
